<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Облік посилок з Firebase</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // --- Твій Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyBzWeUyZuN0xNf5N5JOT_D-PJLwj2x-thQ",
    authDomain: "posylky-e4e65.firebaseapp.com",
    databaseURL: "https://posylky-e4e65-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "posylky-e4e65",
    storageBucket: "posylky-e4e65.firebasestorage.app",
    messagingSenderId: "27028799548",
    appId: "1:27028799548:web:21aea53b9d746d21bcc339",
    measurementId: "G-HDVSHXB75Q"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window.parcels = [];
  window.trips = [];
  window.clients = {};

  // -------------------- Функції --------------------
  window.sendParcelToFirebase = function(parcel){
      set(ref(db,'parcels/'+parcel.id),parcel)
      .then(()=>console.log('Збережено у Firebase'))
      .catch(err=>console.error('Помилка Firebase',err));
  }

  window.deleteParcel = function(id){
      if(confirm("Видалити цю посилку?")){
          remove(ref(db,'parcels/'+id));
      }
  }

  onValue(ref(db,'parcels/'), snapshot=>{
      const data = snapshot.val();
      if(data){
          window.parcels = Object.values(data);
          window.trips = [...new Set(window.parcels.map(p=>p.trip))];
          window.clients = {};
          window.parcels.forEach(p=>{
              if(p.phone) window.clients[p.phone]={city:p.city, name:p.name, np:p.np};
          });
          renderTripSelect();
          renderTripsTables();
      }
  });

  function renderTripSelect(){
      const select = document.getElementById('tripSelect');
      select.innerHTML = window.trips.map(t=>`<option value="${t}">${t}</option>`).join('');
  }

  window.addTrip = function(){
      const name=document.getElementById('newTrip').value.trim();
      if(!name) return alert("Введіть назву рейсу");
      if(!window.trips.includes(name)) window.trips.push(name);
      document.getElementById('newTrip').value='';
      renderTripSelect();
      renderTripsTables();
  }

  window.addParcel = function(){
      const trip = document.getElementById('tripSelect').value;
      if(!trip) return alert("Створіть рейс!");
      const parcel={
          id:Date.now(),
          trip,
          number:document.getElementById('parcelNumber').value,
          phone:document.getElementById('phone').value,
          city:document.getElementById('city').value,
          name:document.getElementById('fullName').value,
          np:document.getElementById('np').value,
          places:document.getElementById('places').value,
          weight:document.getElementById('weight').value,
          price:document.getElementById('price').value,
          note:document.getElementById('note').value
      };
      if(parcel.phone) window.clients[parcel.phone]={city:parcel.city,name:parcel.name,np:parcel.np};
      window.parcels.push(parcel);
      sendParcelToFirebase(parcel);
      renderTripsTables();

      ['parcelNumber','phone','city','fullName','np','places','weight','price','note'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('parcelNumber').focus();
  }

  window.autoFillClient = function(){
      const phone = document.getElementById('phone').value;
      if(window.clients[phone]){
          document.getElementById('city').value=window.clients[phone].city||'';
          document.getElementById('fullName').value=window.clients[phone].name||'';
          document.getElementById('np').value=window.clients[phone].np||'';
      }
  }

  function renderTripsTables(){
      const container=document.getElementById('tripsContainer');
      container.innerHTML='';
      window.trips.forEach(tripName=>{
          const tripParcels = window.parcels.filter(p=>p.trip===tripName);
          if(tripParcels.length===0) return;
          const section=document.createElement('div'); section.className='trip-section';
          section.innerHTML=`<h3>Рейс: ${tripName}</h3>`;
          const table=document.createElement('table');
          table.innerHTML=`<thead><tr>
            <th>№</th><th>Телефон</th><th>Місто</th><th>ПІБ</th>
            <th>Відділення</th><th>Місця</th><th>Вага</th>
            <th>Ціна</th><th>Примітка</th><th>Дії</th>
          </tr></thead>`;
          const tbody=document.createElement('tbody');
          tripParcels.forEach(p=>{
              const tr=document.createElement('tr');
              tr.innerHTML=`<td>${p.number}</td><td>${p.phone}</td><td>${p.city}</td><td>${p.name}</td>
                  <td>${p.np}</td><td>${p.places}</td><td>${p.weight}</td>
                  <td>${p.price}</td><td>${p.note}</td>
                  <td><button class="delete-btn" onclick="deleteParcel(${p.id})">Видалити</button></td>`;
              tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          section.appendChild(table);
          const total = tripParcels.reduce((sum,p)=>sum+(parseFloat(p.price)||0),0);
          section.innerHTML += `<div class="total">Сума рейсу: ${total.toFixed(2)} грн</div>`;
          container.appendChild(section);
      });
  }

  // Enter переход між полями
  const fieldsOrder=['parcelNumber','phone','city','fullName','np','places','weight','price','note'];
  window.addEventListener('DOMContentLoaded', ()=>{
      fieldsOrder.forEach((id,index)=>{
          document.getElementById(id).addEventListener('keydown',function(e){
              if(e.key==='Enter'){
                  e.preventDefault();
                  const nextIndex=index+1;
                  if(nextIndex<fieldsOrder.length) document.getElementById(fieldsOrder[nextIndex]).focus();
                  else window.addParcel();
              }
          });
      });
  });
</script>

<style>
body { font-family: Arial; padding:15px; background:#f2f2f2; }
input, select, button { width:100%; padding:10px; margin:5px 0; font-size:16px; }
button { background:#007aff; color:white; border:none; border-radius:8px; cursor:pointer; }
button.red { background:red; font-size:14px; padding:5px 10px; }
table { width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; }
th, td { border:1px solid #ccc; padding:5px; text-align:left; }
th { background:#ddd; }
.total { font-size:16px; font-weight:bold; margin-top:5px; }
h2 { margin-top:20px; }
.trip-section { margin-bottom:40px; padding:10px; background:#fff; border-radius:8px; }
.delete-btn { background:red; font-size:12px; padding:3px 6px; }
</style>
</head>
<body>

<h2>Створити новий рейс</h2>
<input id="newTrip" placeholder="Назва рейсу">
<button onclick="addTrip()">Створити рейс</button>

<h2>Додати посилку</h2>
<select id="tripSelect"></select>

<input id="parcelNumber" placeholder="Номер посилки">
<input id="phone" placeholder="Телефон" oninput="autoFillClient()">
<input id="city" placeholder="Місто">
<input id="fullName" placeholder="Прізвище Ім'я">
<input id="np" placeholder="Відділення Нової Пошти">
<input id="places" placeholder="Кількість місць">
<input id="weight" placeholder="Вага">
<input id="price" placeholder="Ціна">
<input id="note" placeholder="Примітка">

<button onclick="addParcel()">Додати посилку</button>

<div id="tripsContainer"></div>

</body>
</html>
